# 项目架构与代码质量硬性指标

本文档列出本仓库应遵守的硬性指标与代码质量关注点。所有贡献者（包括自动化脚本）必须遵守这些规则；CI/提交钩子应尽可能自动检测并在 PR 中反馈违规项。

核心硬性指标

- 单个源代码文件的长度限制：不超过 500 行（适用于 Python、JavaScript、TypeScript、Java、Go、Rust、Swift 等）。
- 每个目录下的文件数量：尽可能不超过 8 个；若超过，应将功能拆分为子目录以降低复杂度。

代码味道（Bad Smells）——定义与处置原则

1) 僵化 (Rigidity)
  - 定义：系统难以变更，做小改动需要连锁修改。
  - 发现方式：高耦合文件、变更影响范围广、接口兼容性问题。
  - 处置建议：抽象接口、依赖注入、减少全局状态、编写单元测试覆盖边界。

2) 冗余 (Redundancy)
  - 定义：相同逻辑在多处重复实现。
  - 发现方式：在代码审查或静态分析中发现重复段落（相似字符串/函数）。
  - 处置建议：提取公用函数/模块、引入共享工具库、编写复用的单元测试。

3) 循环依赖 (Circular Dependency)
  - 定义：模块间存在相互引用，难以单独测试或复用。
  - 发现方式：构建/编译器报错、导入图分析、手动审计。
  - 处置建议：重新划分模块边界、使用接口/协议解耦、引入中介层。

4) 脆弱性 (Fragility)
  - 定义：对一处改动导致其他无关代码出错。
  - 发现方式：回归测试失效、PR 引入多个不相关失败。
  - 处置建议：增加自动化测试、明确模块契约、减少隐式依赖。

5) 晦涩性 (Obscurity)
  - 定义：代码意图不明、变量命名或结构让阅读者迷惑。
  - 发现方式：代码审查反馈、低可读性评分工具。
  - 处置建议：重命名、拆分复杂函数、补充注释与文档。

6) 数据泥团 (Data Clump)
  - 定义：多个参数总是一起出现，说明它们应被聚合成对象。
  - 发现方式：方法签名中大量重复参数。
  - 处置建议：封装为数据对象/结构体并传递该对象。

7) 不必要的复杂性 (Needless Complexity)
  - 定义：过度设计，解决问题使用不必要的复杂方案。
  - 发现方式：实现与需求不符、过量抽象。
  - 处置建议：简化设计、优先简单可行的实现（YAGNI 原则）。

自动化检测建议（优先级）

- 静态检查：对 Swift 项目建议集成 `SwiftLint`，配置规则应包含文件长度、行长、未使用的导入等。
- 自定义脚本：增加 `tools/check_architecture.sh` 用于检查单文件行数和每层文件数量（将在 TODO 中实现）。
- CI 与 pre-commit：在 PR/提交时运行静态检查并在发现坏味道时自动注记 PR。

流程与决策

- 发现“坏味道”后：自动注记 PR 并建议具体重构步骤（例如：建议将 `Foo.swift` 拆分为 `Foo/View.swift` 和 `Foo/Model.swift`）。
- 若检测到违反硬性指标（例如单文件行数 > 500）：阻止合并并要求作者拆分文件或说明理由并提议例外流程。

验收标准

- 本文件存在于仓库根目录，内容详尽并可被 CI/脚本引用。
- 将在后续 TODO 中提供能自动检测这些规则的脚本与 CI 配置。

维护说明

此文档由仓库维护者负责更新。若需要修改硬性指标，须在主分支外创建 PR，说明变更理由并通过审查流程。
